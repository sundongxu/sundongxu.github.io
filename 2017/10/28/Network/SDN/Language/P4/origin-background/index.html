<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="P4,OpenFlow,SDN,Network Measurement," />





  <link rel="alternate" href="/atom.xml" title="Sun Dongxu's Blog" type="application/atom+xml" />






<meta name="description" content="全文概要 软件定义网络(Software Defined Network, SDN)核心在于网络转发设备的数据转发平面(Data Plane)和控制平面(Control Plane)的分离和解耦，以实现可编程按需定制、集中式统一管理、动态流量监控、自动化部署。2014年P4语言横空出世，进一步提高了面向交换机编程的可行性和效率，成为SDN领域的又一里程碑式的成果。本文从宣告P4诞生的SIGCOMM">
<meta name="keywords" content="P4,OpenFlow,SDN,Network Measurement">
<meta property="og:type" content="article">
<meta property="og:title" content="P4学习笔记：背景起源与基本原理">
<meta property="og:url" content="dongdongdong.me/2017/10/28/Network/SDN/Language/P4/origin-background/index.html">
<meta property="og:site_name" content="Sun Dongxu&#39;s Blog">
<meta property="og:description" content="全文概要 软件定义网络(Software Defined Network, SDN)核心在于网络转发设备的数据转发平面(Data Plane)和控制平面(Control Plane)的分离和解耦，以实现可编程按需定制、集中式统一管理、动态流量监控、自动化部署。2014年P4语言横空出世，进一步提高了面向交换机编程的可行性和效率，成为SDN领域的又一里程碑式的成果。本文从宣告P4诞生的SIGCOMM">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://oyj8xdeki.bkt.clouddn.com/images/Network/SDN/Language/P4/origin-background/forwarding-model.png">
<meta property="og:image" content="http://oyj8xdeki.bkt.clouddn.com/images/Network/SDN/Language/P4/origin-background/p4-vs-openflow.png">
<meta property="og:image" content="http://oyj8xdeki.bkt.clouddn.com/images/Network/SDN/Language/P4/origin-background/control-flow-for-mTag.png">
<meta property="og:image" content="http://oyj8xdeki.bkt.clouddn.com/images/Network/SDN/Language/P4/origin-background/table-dependency-graph.png">
<meta property="og:updated_time" content="2018-05-14T07:48:17.273Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="P4学习笔记：背景起源与基本原理">
<meta name="twitter:description" content="全文概要 软件定义网络(Software Defined Network, SDN)核心在于网络转发设备的数据转发平面(Data Plane)和控制平面(Control Plane)的分离和解耦，以实现可编程按需定制、集中式统一管理、动态流量监控、自动化部署。2014年P4语言横空出世，进一步提高了面向交换机编程的可行性和效率，成为SDN领域的又一里程碑式的成果。本文从宣告P4诞生的SIGCOMM">
<meta name="twitter:image" content="http://oyj8xdeki.bkt.clouddn.com/images/Network/SDN/Language/P4/origin-background/forwarding-model.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="dongdongdong.me/2017/10/28/Network/SDN/Language/P4/origin-background/"/>





  <title>P4学习笔记：背景起源与基本原理 | Sun Dongxu's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6b59978ef5e74a1232a0ca20456b8fda";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
      <a href="https://github.com/sundongxu"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sun Dongxu's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Reorganizing the Organization, Rebuilding the Building.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="dongdongdong.me/2017/10/28/Network/SDN/Language/P4/origin-background/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Dongxu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/la.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sun Dongxu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">P4学习笔记：背景起源与基本原理</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-28T10:29:26+08:00">
                2017-10-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/" itemprop="url" rel="index">
                    <span itemprop="name">Network</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/10/28/Network/SDN/Language/P4/origin-background/" class="leancloud_visitors" data-flag-title="P4学习笔记：背景起源与基本原理">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6,667
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  25
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="全文概要"><a href="#全文概要" class="headerlink" title="全文概要"></a>全文概要</h2><hr>
<p>软件定义网络(<a href="https://en.wikipedia.org/wiki/Software-defined_networking" target="_blank" rel="noopener"><strong>Software Defined Network, SDN</strong></a>)核心在于网络转发设备的数据转发平面(<strong>Data Plane</strong>)和控制平面(<strong>Control Plane</strong>)的分离和解耦，以实现可编程按需定制、集中式统一管理、动态流量监控、自动化部署。2014年<a href="https://p4.org/" target="_blank" rel="noopener"><strong>P4</strong></a>语言横空出世，进一步提高了面向交换机编程的可行性和效率，成为SDN领域的又一里程碑式的成果。本文从宣告P4诞生的<a href="https://www.sigcomm.org/" target="_blank" rel="noopener"><strong>SIGCOMM</strong></a>会议论文出发，介绍其背景起源、基本原理以及未来广阔的应用前景。<br><a id="more"></a></p>
<h2 id="行业趋势"><a href="#行业趋势" class="headerlink" title="行业趋势"></a>行业趋势</h2><hr>
<p><strong>SDN is the future, and P4 defines it.<br>SDN是未来，P4定义未来。</strong></p>
<h2 id="相关论文"><a href="#相关论文" class="headerlink" title="相关论文"></a>相关论文</h2><hr>
<p>Proposed in <a href="https://www.sigcomm.org/publications/computer-communication-review" target="_blank" rel="noopener">SIGCOMM Communication Review[J]</a>, 2014.<br>-<a href="https://arxiv.org/pdf/1312.1719.pdf" target="_blank" rel="noopener"><strong>《P4: Programming Protocol-Independent Packet Processors》</strong></a></p>
<h2 id="背景起源"><a href="#背景起源" class="headerlink" title="背景起源"></a>背景起源</h2><hr>
<p>P4是由P.Bosshart等人提出的一种用于处理数据包转发的高层抽象语言，协议独立(<strong>Protocol-Independent</strong>)是其核心特点，如OpenFlow一样是一种<a href="https://zhuanlan.zhihu.com/p/26743952" target="_blank" rel="noopener"><strong>南向协议</strong></a>，但是其应用范围要比OpenFlow还要大：不仅可以指导数据流转发，更提供了对交换机等网络转发设备的SDN数据平面的编程接口，实现了在设备层对数据处理流程进行软件定义，是真正意义上的软件定义网络。</p>
<p>就如论文中所说：</p>
<blockquote>
<p>We propose P4 as a strawman proposal for how OpenFlow should evolve in the Future.</p>
</blockquote>
<p>目前，P4语言作为一种潜在的<strong>OpenFlow2.0</strong>的发展方向在努力。</p>
<p>与华为<a href="http://www.poforwarding.org" target="_blank" rel="noopener"><strong>POF(Protocol Oblivious Forwarding)</strong></a>提出目的类似，P4的提出的目的也是为了解决OpenFlow可编程能力不足及其协议设计本身所带来的高复杂度(<strong>Complexity</strong>)和较差可扩展性(<strong>Scalability</strong>)的难题。</p>
<p>自从OpenFlow 1.0发布以来，其版本目前已演进到<a href="https://www.opennetworking.org/wp-content/uploads/2014/10/openflow-switch-v1.5.1.pdf" target="_blank" rel="noopener"><strong>1.5</strong></a>，为了兼容多种不同的网络协议，使OpenFlow交换机能够处理具有不同头部的数据包，其匹配域(<strong>Header Field</strong>)的个数从1.0版本的12元组，变成1.3版本的40个，到最新1.5版本的45个，其匹配域数目随着新版本支持特性的更新不断增加，OpenFlow匹配域个数随版本演变情况具体见下表：</p>
<style> 
  table th:nth-of-type(1) {
      width: 150px; 
  }
</style>

<style>
  table th:nth-of-type(2) {
      width: 150px;
}
</style>

<table>
<thead>
<tr>
<th style="text-align:center">Version</th>
<th style="text-align:center">Date</th>
<th style="text-align:center">Header Fields</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">OF 1.0</td>
<td style="text-align:center">Dec 2009</td>
<td style="text-align:center">12 fields(Ethernet, TCP/IPv4)</td>
</tr>
<tr>
<td style="text-align:center">OF 1.1</td>
<td style="text-align:center">Feb 2011</td>
<td style="text-align:center">15 fields(MPLS, inter-table metadata)</td>
</tr>
<tr>
<td style="text-align:center">OF 1.2</td>
<td style="text-align:center">Dec 2011</td>
<td style="text-align:center">36 fields(ARP, ICMP, IPv6, etc)</td>
</tr>
<tr>
<td style="text-align:center">OF 1.3</td>
<td style="text-align:center">Jun 2012</td>
<td style="text-align:center">40 fields</td>
</tr>
<tr>
<td style="text-align:center">OF 1.4</td>
<td style="text-align:center">Oct 2013</td>
<td style="text-align:center">41 fields</td>
</tr>
<tr>
<td style="text-align:center">OF 1.5</td>
<td style="text-align:center">Dec 2014</td>
<td style="text-align:center">45 fields</td>
</tr>
</tbody>
</table>
<p>但OpenFlow本身并不支持弹性增加匹配域，因此每次增加一个匹配域就需要重新编写控制器(<strong>Controller</strong>)和交换机两端的协议栈，以及交换机的数据包处理逻辑，并分别烧制到OpenFlow控制器和交换机芯片上，这无疑大大增加了交换机设计的难度，高昂的更新成本也严重影响OpenFlow协议的版本稳定性，阻碍了OpenFlow的推广。</p>
<h2 id="语言特性"><a href="#语言特性" class="headerlink" title="语言特性"></a>语言特性</h2><hr>
<p>根据论文所述，P4致力于实现以下三个目标：</p>
<ol>
<li><p><strong>可重配置性(Reconfigurability)</strong></p>
<blockquote>
<p>Programmers should be able to change the way switches process packets once they are deployed.</p>
</blockquote>
<p> 可灵活定义转发设备数据处理流程，且能够做到转发无中断的重配置。OpenFlow能够在已经固化在交换机上的数据处理逻辑之上，通过流表项指导数据流转发处理，而无法重新定义交换机处理数据的逻辑，每次增加新的网络协议支持，都必须将相关设备宕机下线并重新配置后再重新部署上线，即无法在不中断其它数据包转发的情况下弹性支持新协议。而P4语言的<strong>卖点</strong>恰恰在于其拥有对交换机的数据平面，即数据包处理逻辑即时编程的能力。</p>
</li>
<li><p><strong>协议无关性(Protocol-Independence)</strong></p>
<blockquote>
<p>Switches should not be tied to any specific network protocols.</p>
</blockquote>
<p> 交换机等转发设备无需关心协议语法和语义等内容，依然能够完成数据转发任务。这是使用P4可以自定义数据处理逻辑，并通过控制器对交换机等转发设备编程配置实现对应的协议处理逻辑，而这个行为(<strong>Behavior</strong>)将被翻译成对应的匹配(<strong>Match</strong>)和动作(<strong>Action</strong>)，从而被转发设备理解和执行。</p>
</li>
<li><p><strong>目标设备无关性(Target-Independence)</strong></p>
<blockquote>
<p>Programmers should be able to describe packet-processing functionality independently of the underlying hardware.</p>
</blockquote>
<p> 正如写C和Java(CPU-oriented Languauge，面向CPU编程语言)代码时并不需要了解CPU的相关信息(型号、参数等等硬件细节)，使用P4语言进行网络编程同样无需关心底层转发设备的具体信息。P4的编译器(Compiler)会将通用的P4语言处理逻辑翻译成设备所能理解的机器指令，并将其写入转发设备，完成配置和编程。</p>
</li>
</ol>
<h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><hr>
<h3 id="转发模型-Forwarding-Model"><a href="#转发模型-Forwarding-Model" class="headerlink" title="转发模型(Forwarding Model)"></a>转发模型(Forwarding Model)</h3><p>论文中提出的数据包转发抽象模型如下图所示，交换机通过一个可编程的解析器(<strong>Parser</strong>)以及其后紧跟的多个”匹配-动作”操作阶段，或顺序，或并行，或组合两种模式，完成数据包的转发任务。<br><img src="http://oyj8xdeki.bkt.clouddn.com/images/Network/SDN/Language/P4/origin-background/forwarding-model.png"></p>
<p>模型概括了数据包是如何在<strong>不同转发设备</strong>(包括：以太网交换机、负载均衡器、路由器)中，通过<strong>不同技术</strong>(包括：固定功能交换机ASIC芯片、网络处理器(Network Processor Unit，NPU)、现场可编程门阵列(Field Programmable Gate Array，FPGA)、可重配置交换机、软件交换机)处理的。</p>
<p>基于此转发模型，设计出P4这样一种数据平面编程语言，用于描述数据包处理逻辑。从此，开发人员只需编写高层抽象的目标无关(<strong>Target-Inpendent</strong>)的P4程序，而无需关心底层设备细节，编译器会负责将程序映射到不同的底层转发设备，支持设备的种类范围从转发相对较慢的软件交换机到最快的基于ASIC的交换机，编译器都能将P4程序最终翻译成设备能理解并执行的机器指令。</p>
<p>转发模型由两种类型的操作所控制：</p>
<ol>
<li><strong>配置(Configure)</strong>：对解析器编程，设置各个匹配-动作阶段的执行顺序，并且指定每个阶段应处理的头部字段；</li>
<li><strong>部署(Populate)</strong>：动态增加、删除在配置阶段创建的匹配-动作表中的条目(<strong>Entry</strong>)。</li>
</ol>
<p><strong>配置操作(Configuration)</strong>决定了网络转发设备所支持的协议和数据包处理的逻辑，而<strong>部署操作(Population)</strong>决定了在给定时间内对数据包应用的处理策略(<strong>Policy</strong>)。配置与部署实际被设计成两个不同的阶段(<strong>Phase</strong>)，在配置阶段交换机不需要能够处理数据包，但是需要在部分或者全部重新配置(<strong>Reconfigure</strong>)阶段依然能够做到无宕机，即无中断的数据包处理。</p>
<p>根据转发模型，数据包到达交换机后，先由解析器处理，由于匹配阶段只需要头部信息(<strong>Packet Header</strong>)，故将数据体(<strong>Packet Body</strong>)先分别缓存。解析器识别并提取出特定头部字段，这实际定义了交换机支持的协议类型，在这些字段上面，会执行匹配操作，并根据匹配结果执行相关动作。</p>
<p>被提取的字段随后被传送给匹配-动作表，表被分成两个部分：入口表(<strong>Ingress Table</strong>)和出口表(<strong>Egress Table</strong>)。两者都可能会修改数据包头部，入口表决定了数据包的输出端口及其应该被放置的队列。被入口表处理时，数据包可能会被转发、复制(多播、发送至控制平面)、丢弃或触发流量控制。出口表执行对数据包头部的修改，如针对多播数据包的修改。</p>
<p>在不同处理阶段之间，数据包还可以携带额外信息，称作”元数据“，常见的元数据例如：输入端口、目的地址、队列、时间戳和虚拟网络标识符等等。</p>
<p>排队机制(<strong>Queuing Discipline</strong>)则是借鉴了OpenFlow中的做法：一个动作将一个数据包映射到一个队列，每个队列都会接受某种在交换机配置阶段就选定的服务类型(<strong>Service Discipline，受限水平这里不太理解，还请指教～</strong>)的数据包。</p>
<h4 id="P4-VS-OpenFlow"><a href="#P4-VS-OpenFlow" class="headerlink" title="P4 VS OpenFlow"></a>P4 VS OpenFlow</h4><p>与OpenFlow相比，P4的设计有三个优点：</p>
<ol>
<li>P4可编程定制数据解析流程，即<strong>Programmable Parser</strong>，而OpenFlow交换机只支持固定的包处理解析逻辑，即<strong>Fixed Parser</strong>；</li>
<li>P4可执行串行(<strong>Serial</strong>)和并行(<strong>Parallel</strong>)的Match-Action操作，而OpenFlow仅支持串行操作；</li>
<li>由于P4模型包含程序编译器，负责完成将P4程序到具体交换设备配置的映射，从而支持协议无关的转发，而OpenFlow支持的协议需要在初始时配置，此后每次修改都需要宕机，编写新的协议数据包处理逻辑再配置到交换机，不能做到无转发中断的弹性增加所支持的协议。<img src="http://oyj8xdeki.bkt.clouddn.com/images/Network/SDN/Language/P4/origin-background/p4-vs-openflow.png">
</li>
</ol>
<h3 id="核心部件-Key-Component"><a href="#核心部件-Key-Component" class="headerlink" title="核心部件(Key Component)"></a>核心部件(Key Component)</h3><h4 id="头部-Header"><a href="#头部-Header" class="headerlink" title="头部(Header)"></a>头部(Header)</h4><p>对数据包的处理都需要根据包头的字段内容来决定对其采取什么操作，所以在P4程序中需要定义对应的包头。</p>
<blockquote>
<p>A header definition describes the sequence and structure of a series of  fields. It includes specification of field widths and constraints on field values.</p>
</blockquote>
<p>包头本质上就是有序排列的字段序列，包头由有序的字段名称即对应的字段长度组成，其中以太网和VLAN的包头格式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">header ethernet &#123;</span><br><span class="line">    fields &#123;</span><br><span class="line">        dst_addr : <span class="number">48</span>; <span class="comment">// width in bits</span></span><br><span class="line">        src_addr : <span class="number">48</span>;</span><br><span class="line">        ethertype : <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header vlan &#123;</span><br><span class="line">    fields &#123;</span><br><span class="line">        pcp : <span class="number">3</span>;</span><br><span class="line">        cfi : <span class="number">1</span>;</span><br><span class="line">        vid : <span class="number">12</span>;</span><br><span class="line">        ethertype : <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是一个称作<strong>mTag</strong>的头部定义，它能够在数据包被处理的过程中在不影响已有字段声明的情况下被添加至其头部，携带额外的处理信息，作为我们的一个P4程序的完整实例的一部分引入。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">header mTag &#123;</span><br><span class="line">    fields &#123;</span><br><span class="line">        up1: <span class="number">8</span>;</span><br><span class="line">        up2: <span class="number">8</span>;</span><br><span class="line">        down1: <span class="number">8</span>;</span><br><span class="line">        down2: <span class="number">8</span>;</span><br><span class="line">        ethertype: <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="解析器-Parser"><a href="#解析器-Parser" class="headerlink" title="解析器(Parser)"></a>解析器(Parser)</h4><p>在定义了包头之后，还需要定义头部字段之间的关系，及数据包解析的对应关系。</p>
<blockquote>
<p>A parser definition specifies how to identify headers and valid header sequences within packets.</p>
</blockquote>
<p>比如以太网头部的<strong>ethertype</strong>字段在等于<strong>0x0800</strong>时应该继续跳转至IPv4的头部进行后续解析。下面仍以以太网头部解析(<strong>parser ethernet</strong>表示本解析器专门用来解析以太网头部)为例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">parser ethernet &#123;</span><br><span class="line">    <span class="keyword">switch</span>(ethertype)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x8100</span>: vlan;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x9100</span>: vlan;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x0800</span>: ipv4;</span><br><span class="line">        <span class="comment">// Other cases</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>P4假设底层交换机能实现一个从头到尾遍历数据包头部的状态机(<strong>State Machine</strong>)，并在该遍历过程中依次提取(<strong>Extract</strong>)出头部各字段内容，这些字段内容最终会被送到下面介绍的Match-Action表中统一处理。</p>
<p>P4将此状态机描述为一个从一个头部字段到下一个头部字段的转换(<strong>Transition</strong>)的集合，每次转换由当前头部字段的具体取值所触发。下面我们会描述一个<strong>mTag</strong>状态机：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">parser start &#123;</span><br><span class="line">    ethernet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">parser ethernet &#123;</span><br><span class="line">    <span class="keyword">switch</span>(ethertype)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x8100</span>: vlan;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x9100</span>: vlan;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x0800</span>: ipv4;</span><br><span class="line">        <span class="comment">// Other cases</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">parser vlan &#123;</span><br><span class="line">    <span class="keyword">switch</span>(ethertype)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xaaaa</span>: mTag;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x0800</span>: ipv4;</span><br><span class="line">        <span class="comment">// Other cases</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">parser mTag &#123;</span><br><span class="line">    <span class="keyword">switch</span>(ethertype) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x0800</span>: ipv4;</span><br><span class="line">        <span class="comment">// Other cases</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，所有的解析均从start状态开始，并在到达stop状态或出错之后结束。解析器用于将字节流数据解析为对应的协议报文，用于后续的流表项匹配和动作执行。</p>
<p>一旦解析来到一个新的头部，即到达一个新状态，状态机利用其配置信息(<strong>Specification</strong>)将头部提取出来，并确定其下一次转换。被提取出的头部被转发至交换机流水线后半段执行的Match-Action操作处理。</p>
<h4 id="匹配-动作表-Match-Action-Table"><a href="#匹配-动作表-Match-Action-Table" class="headerlink" title="匹配-动作表(Match-Action Table)"></a>匹配-动作表(Match-Action Table)</h4><p>P4中需要定义多种类型用途的表用于存储匹配表项，格式为Match+Action，即匹配域(头部部分字段的组合)和对应的执行动作。P4语言定义某个表具体的匹配域及需要执行的动作。而具体的流表项会在网络运行过程中通过控制器来编程下发，从而完成对应数据流的处理。因此，匹配-动作表，实际定义或决定了相关数据包的处理逻辑。</p>
<blockquote>
<p>Match+action tables are the mechanism for performing packet processing. The P4 program defines the fields on which a table may match and the actions it may execute.</p>
</blockquote>
<p>接着上文中<strong>mTag</strong>的例子，边缘交换机(<strong>Edge Switch</strong>)会匹配二层目的地址(数据链路层目的地址，即目的MAC地址)和VLAN ID，并且将<strong>mTag</strong>添加到数据包头部, 从而数据包在交换网络中就可以通过匹配<strong>mtag</strong>来完成转发。下面P4程序定义了一个表来<strong>匹配</strong>上述字段，并且对数据包应用一个添加<strong>mTag</strong>头部的<strong>动作</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">table mTag_table &#123;</span><br><span class="line">    reads &#123;</span><br><span class="line">        ethernet.dst_addr: exact;</span><br><span class="line">        vlan.vid: exact;</span><br><span class="line">    &#125;</span><br><span class="line">    actions &#123;</span><br><span class="line">        <span class="comment">// At runtime, entries are programmed with params</span></span><br><span class="line">        <span class="comment">// for the mTag action, see below.</span></span><br><span class="line">        add_mTag;</span><br><span class="line">    &#125;</span><br><span class="line">    max_size: <span class="number">20000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>表中各属性意义如下：</p>
<ul>
<li><strong>reads</strong>：声明匹配域，即需要匹配的字段，由匹配类型量化，包括：<strong>exact</strong>(精确匹配，完全匹配)、<strong>ternary</strong>、<strong>ranges</strong>(一定范围内)、wildcard(通配符)；</li>
<li><strong>actions</strong>: 列举本表可能对被匹配的数据包采取的动作，动作会在下一小节重点阐述；</li>
<li><strong>maxsize</strong>: 规定本表所能支持的最大条目容量。</li>
</ul>
<p>为了在后文继续讨论<strong>mTag</strong>的后续处理流程，还定义了如下三个表：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">table source_check &#123;</span><br><span class="line">    <span class="comment">// Verify mtag only on ports to the core</span></span><br><span class="line">    reads &#123;</span><br><span class="line">        mtag: valid; <span class="comment">// Was mtag parsed?</span></span><br><span class="line">        metadata.ingress_port: exact;</span><br><span class="line">    &#125;</span><br><span class="line">    actions &#123;</span><br><span class="line">        <span class="comment">// Each table entry specifies one action</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// If inappropriate mTag, send to CPU</span></span><br><span class="line">        fault_to_cpu;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If mtag found, strip and record in metadata</span></span><br><span class="line">        strip_mtag;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Otherwise, allow the packet to continue</span></span><br><span class="line">        pass;</span><br><span class="line">    &#125;</span><br><span class="line">    max_size: <span class="number">64</span>; <span class="comment">// One rule per port</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table local_switching &#123;</span><br><span class="line">    <span class="comment">// Reads destination and checks if local</span></span><br><span class="line">    <span class="comment">// If miss occurs, goto mtag table</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table egress_check &#123;</span><br><span class="line">    <span class="comment">// Verify egress is resolved</span></span><br><span class="line">    <span class="comment">// Do not retag packets received with tag</span></span><br><span class="line">    <span class="comment">// Reads egress and whether packet was mTagged</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="动作-Action"><a href="#动作-Action" class="headerlink" title="动作(Action)"></a>动作(Action)</h4><p>与OpenFlow的动作类似，不过P4程序中的动作是抽象程度更高的协议无关的操作。P4定义了一套协议无关的原始指令集(<strong>Primitive</strong>，原语)，基于该指令集可以实现复杂的协议操作，这可以通过赋予不同的参数来调用这些原始指令集组合来实现，而这些参数还可以是数据包匹配过程中产生的元数据。</p>
<p>P4假定一个动作函数(<strong>Action Function</strong>)里的原语都是可并行执行的，而原本不支持并行的交换机则可以通过仿真来实现类似效果(缺乏对交换机硬件结构的详细理解，暂留疑问，欢迎指教～)。</p>
<blockquote>
<p>P4 supports construction of complex actions from simpler protocol-independent primitives. These complex actions are available within match+action tables.</p>
</blockquote>
<p>上文提到的<strong>add_mTag</strong>动作用P4表述如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">action <span class="title">add_mTag</span><span class="params">(up1, up2, down1, down2, egr_spec)</span> </span>&#123;</span><br><span class="line">    add_header(mTag);</span><br><span class="line">    <span class="comment">// Copy VLAN ethertype to mTag</span></span><br><span class="line">    copy_field(mTag.ethertype, vlan.ethertype);</span><br><span class="line">    <span class="comment">// Set VLAN's ethertype to signal mTag</span></span><br><span class="line">    set_field(vlan.ethertype, <span class="number">0xaaaa</span>);</span><br><span class="line">    set_field(mTag.up1, up1);</span><br><span class="line">    set_field(mTag.up2, up2);</span><br><span class="line">    set_field(mTag.down1, down1);</span><br><span class="line">    set_field(mTag.down2, down2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the destination egress port as well</span></span><br><span class="line">    set_field(metadata.egress_spec, egr_spec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从以上程序可以看出<strong>mTag</strong>动作的执行流程：交换机将<strong>mTag</strong>插入到<strong>VLAN tag</strong>之后，将<strong>VLAN tag</strong>的<strong>ethertype</strong>赋值给<strong>mTag</strong>的对应字段从而暗示(Indicate)后面接的字段是<strong>VLAN</strong>头部，然后将<strong>VLAN tag</strong>的<strong>ethertype</strong>赋值为<strong>0xaaaa</strong>来唤醒<strong>parser mTag</strong>处理<strong>mTag</strong>这个新增头部。</p>
<p>P4支持的原语动作集包括：</p>
<ul>
<li><strong>set_field</strong>：为头部中某个特定字段赋值；</li>
<li><strong>copy_field</strong>：将参数二的字段值赋给参数一代表的字段；</li>
<li><strong>add_header</strong>：将一个特定的头部实例(或其包含的全部字段)设为有效(valid)的；</li>
<li><strong>remove_header</strong>：从一个数据包删除其头部(或其头部包含的全部字段)；</li>
<li><strong>increment</strong>：增加或减小一个字段的值；</li>
<li><strong>checksum</strong>：为一个字段集合计算校验和(如IPv4头部，根据其全部字段计算校验和)。</li>
</ul>
<h4 id="控制程序-Control-Program"><a href="#控制程序-Control-Program" class="headerlink" title="控制程序(Control Program)"></a>控制程序(Control Program)</h4><p>一旦表和动作都已完成定义，剩下的任务就是指定从一个表到下一个表的控制流。在P4程序中，控制流通过一系列函数(<strong>Functions</strong>)、条件(<strong>Conditionals</strong>)和表引用(<strong>Table References</strong>)来指定。</p>
<blockquote>
<p>The control program determines the order of match+action tables that are applied to a packet. A simple imperative program describe the flow of control between match+action tables.</p>
</blockquote>
<p>控制程序决定了数据包处理阶段的具体顺序，即数据包在不同匹配表中间的跳转关系。当表和动作被定义和实现之后，还需要控制程序来确定不同表之间的控制流。P4的控制流包括用于数据处理的表、判决条件以及条件成立时所需采取的操作等组件。</p>
<p>下图显示了在边缘交换机上<strong>mTag</strong>包处理逻辑示例的控制流：<br><img src="http://oyj8xdeki.bkt.clouddn.com/images/Network/SDN/Language/P4/origin-background/control-flow-for-mTag.png"></p>
<p>被解析(<strong>parser mTag</strong>)之后的数据包，先进入<strong>source_check</strong>表，验证接收到的包和进入端口(Ingress Port)是否和表中的匹配要求一致，即数据包是否包含<strong>mTag</strong>头部，进入端口是否与核心交换机相连。根据该表中的<strong>reads</strong>属性匹配到对应数据包后，由<strong>action</strong>属性指定要采取的动作是：<strong>strip_tag</strong>，即将<strong>mTag</strong>头部从数据包中剥落，并将该数据包是否包含<strong>mTag</strong>头部记录在元数据中，流水线后部分的表可能还会匹配到该元数据，从而避免再次给该数据包打上<strong>mTag</strong>。</p>
<p>之后<strong>local_switching</strong>表被执行，如果该表未能成功匹配，发生了<strong>misses</strong>，则表示该数据包的目的地不是一个与本交换机相连的主机，这时候就需要执行<strong>mTag_table</strong>。而无论本地局部转发(边缘交换机)还是核心转发(核心交换机)，控制流都会进入<strong>egress_check</strong>表，用于处理发往未知目的地的数据包，它会向SDN控制栈发送一个通知。</p>
<p>综上，可以将数据包处理流水线表示成如下P4程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">control <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Verify mTag state and port are consistent</span></span><br><span class="line">    table(source_check);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If no error from source_check, continue</span></span><br><span class="line">    <span class="keyword">if</span>(!defined(metadata.ingress_error)) &#123;</span><br><span class="line">        <span class="comment">// Attempt to switch to end hosts</span></span><br><span class="line">        table(local_switching);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!defined(metadata.egress_spec)) &#123;</span><br><span class="line">            <span class="comment">// Not a known local host; try mtagging</span></span><br><span class="line">            table(mTag_table);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check for unknown egress state pr</span></span><br><span class="line">        <span class="comment">// bad retagging with mTag</span></span><br><span class="line">        table(egress_check);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编译器-Compiler"><a href="#编译器-Compiler" class="headerlink" title="编译器(Compiler)"></a>编译器(Compiler)</h3><p>编写P4程序的五个基本组件后，接下来就需要使用编译器将程序编译并写入到交换机中，其主要分为数据解析逻辑的编译写入和控制流程编译写入。</p>
<p>数据解析部分用于将网络字节流解析为对应的协议报文，并将报文送到接下来的控制流程中进行匹配和处理。</p>
<p>控制流程的编译和写入则分为以下两步：</p>
<ol>
<li>将P4程序编译，生成设备无关的表依赖图(<strong>Table Dependency Graph, TDG</strong>)；</li>
<li>根据特定的底层转发设备的资源和能力，将表依赖图映射到转发设备的资源上。</li>
</ol>
<p>目前P4程序可在软件交换机、拥有RAM和TCAM存储设备的硬件交换机、支持并行表处理的交换机、支持在流水线最后阶段才执行动作的交换机以及拥有少量表资源的交换机等多种交换设备上实现。</p>
<h3 id="工作流-Work-Flow"><a href="#工作流-Work-Flow" class="headerlink" title="工作流(Work Flow)"></a>工作流(Work Flow)</h3><ol>
<li>数据包到来后，首先进入可编程定制(<strong>Programmable</strong>)的解析器，用于实现自定义的数据解析流程(针对头部字段，可将网络字节流解析成对应的协议数据包；</li>
<li><p>数据包解析完毕后是与OpenFlow类似的匹配-动作操作，其流水线(<strong>Pipeline</strong>)支持串行和并行两种模式。受OpenFlow 1.4启发，P4设计的匹配过程也分为入口流水线(<strong>Ingress Pipeline</strong>)和出口流水线(<strong>Egress Pipeline</strong>)两个分离的数据处理流水线；</p>
</li>
<li><p>在定义交换机的处理逻辑时，需要定义数据包处理的依赖关系(<strong>Dependency</strong>)，即数据包头部字段之间的依赖关系，比如要处理IPv4头部字段，可能需要依赖于以太网头部字段的处理。这些依赖关系可以通过P4描述出来，并编译生成表依赖图TDG，其中每个表都是对应的一种协议或者一个类别的数据包的处理。TDG描述了匹配表之间的逻辑关系，输入和对应操作等行为，用于指导交换机进行数据处理。TDG被定义出来之后，将被编译器翻译成交换机所能理解的逻辑(机器指令)，并写入到交换机等交换实体中去，从而完成自定义的数据包处理流程。</p>
<img src="http://oyj8xdeki.bkt.clouddn.com/images/Network/SDN/Language/P4/origin-background/table-dependency-graph.png">
</li>
</ol>
<h2 id="发展趋势"><a href="#发展趋势" class="headerlink" title="发展趋势"></a>发展趋势</h2><hr>
<p>下面一段话引自原作者<a href="http://www.muzixing.com" target="_blank" rel="noopener"><strong>李呈</strong></a>学长，作为正欲入门SDN的小白，正准备拜读其书<a href="http://item.jd.com/12160066.html" target="_blank" rel="noopener"><strong>《重构网络：SDN架构与实现》</strong></a>，就顺便安利一下吧～</p>
<blockquote>
<p>OpenFlow协议目前的框架设计使得OpenFlow无法对转发设备的数据解析以及处理流程进行编程实现，缺少足够的可编程能力。此外，由于OpenFlow的匹配项均为协议相关的，使得每增加一个匹配域均需要对协议栈以及交换机处理流程进行重新编程，而这个过程周期很长，为支持新的OpenFlow协议需要对现有交换机进行升级或者推出新的交换机产品。这样的缺点让OpenFlow协议版本难以稳定，也难以推广。服务提供商在建设网络基础设施时，需要考虑支持OpenFlow什么版本，也要担心未来OpenFlow协议推出新版本时的兼容和设备升级等问题，使得OpenFlow迟迟无法大规模应用。面对OpenFlow的缺陷，P4的推出刚好解决了这个难题。</p>
<p>P4语言支持对交换机处理逻辑进行编程定义，从而使得协议版本在更新迭代时无需购买新设备，只需通过控制器编程更新交换机处理逻辑即可。这种创新解决了OpenFlow编程能力不足，版本不稳定的问题。此外，由于P4可以编程定义交换机处理逻辑，从而使得交换机可以实现协议无关的转发，进而使得底层交换机更加白盒化，适用范围更广，更容易降低设备采购成本。而且作为一门编程语言，P4支持设备无关特性，使得P4可以应用在不同厂家生产的转发设备上，解除了服务提供商对网络设备厂家绑定的顾虑。</p>
<p>自P4诞生以来，得到了业界的关注和认可，目前发展良好。作为一门网络编程语言，其大大简化了网络编程的难度，同时也改善了目前SDN可编程能力不足的问题。P4的主要推动者Nick教授是当下SDN最流行的南向协议OpenFlow协议的发明者之一，Jennifer教授也在网络界的先驱。无论是处于对P4技术本身的认同，还是对Nick教授和Jennifer教授的认同，业界，尤其是学术界都对P4的应用前景十分看好，认为其将成为OpenFlow2.0的可能发展方向。目前，P4组织已经有了非常多的成员，其中不乏AT&amp;T、思科、华为、Intel、腾讯和微软等知名企业以及斯坦福大学，普林斯顿大学和康奈尔大学等多个全球顶尖的学术机构。此外，在P4发展的过程中，已经被多种转发设备支持，比如应用最广泛的软件交换机<a href="http://openvswitch.org/" target="_blank" rel="noopener"><strong>OpenVSwitch</strong></a>以及华为的POF交换机。转发设备硬件厂商的大力支持是P4继续发展的重要保障，也是P4商业发展的大前提。</p>
<p>P4的设计和华为提出的POF十分相似，只不过侧重点和实现方式不同。POF通过{offset,length}来确定数据，强调协议无关，强调指令集，而P4不仅有底层的高度抽象的协议无关指令集，更侧重与控制器端的网络编程语言的构建。还有一点不同的是，同作为开创式的技术，由美国Nick教授等业界先驱推动的P4明显要比由华为提出的POF受到的关注要多，业界对P4的认同也要比POF要高。</p>
<p>P4和POF相同之处在于：作为完全可编程的SDN实现，性能问题是两者需要面临的大问题，也是急需解决的技术难题。而商业因素方面，两者皆会打破目前的网络界生态平衡。选择搭上这个技术发展的顺风车并争取在新的技术领域占据有利地位，还是固守已有行业市场是网络厂商面连的艰难选择。完全可编程SDN的出现，将使网络的重点和热点进一步由硬件转向软件领域，从而使得依靠硬件技术壁垒占据市场有利地位的传统巨头的优势受到严重削减。虽然巨头的决策将很大程度上影响这些创新技术的发展，但是技术必然会朝着更好更优的方向发展，无论是P4还是POF，抑或是其他的解决方案，具有更好可编程性的SDN就在不远的未来。正如SDN的出现一般，是技术发展过程中顺势而为的产物，是不可阻挡的潮流。</p>
</blockquote>
<p>最后送上总结：<br><strong>SDN是未来，P4也势必将在未来的可编程SDN领域大有作为！</strong></p>
<h2 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h2><hr>
<p>[1] GitHub开源项目<a href="https://github.com/p4lang" target="_blank" rel="noopener"><strong>p4lang</strong></a><br>[2] 李呈前辈<a href="http://www.muzixing.com/pages/2016/03/23/p4zhen-zheng-de-sdnhuan-yao-yuan-ma.html" target="_blank" rel="noopener"><strong>博文</strong></a></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>我知道是不会有人点的，但万一有人想不开呢？！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="Sun Dongxu 微信支付"/>
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/P4/" rel="tag"><i class="fa fa-tag"></i> P4</a>
          
            <a href="/tags/OpenFlow/" rel="tag"><i class="fa fa-tag"></i> OpenFlow</a>
          
            <a href="/tags/SDN/" rel="tag"><i class="fa fa-tag"></i> SDN</a>
          
            <a href="/tags/Network-Measurement/" rel="tag"><i class="fa fa-tag"></i> Network Measurement</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/10/30/Network/Hardware/relay/" rel="prev" title="网络互连设备小结">
                网络互连设备小结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox">
  <script type = "text/javascript" src = "//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-59f1e74daa26cba5" async = "async" ></script>
</div>

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments"></div>
    
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='/lib/Valine.min.js'></script>
    <script>
        new Valine({
            av: AV,
            el: '.comments' ,
            verify: true,
            app_id: '',
            app_key: '',
            placeholder: 'Welcome to teach me something!'
        });
    </script>
    


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/la.png"
                alt="Sun Dongxu" />
            
              <p class="site-author-name" itemprop="name">Sun Dongxu</p>
              <p class="site-description motion-element" itemprop="description">Consistency refines Efficiency.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">68</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/sundongxu" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/sun-dong-xu-6/activities" target="_blank" title="知乎">
                    
                      <i class="fa fa-fw fa-graduation-cap"></i>知乎</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://weibo.com/u/2864802550" target="_blank" title="微博">
                    
                      <i class="fa fa-fw fa-weibo"></i>微博</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.cnblogs.com/burningTheStar" title="秋波园" target="_blank">秋波园</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#全文概要"><span class="nav-number">1.</span> <span class="nav-text">全文概要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#行业趋势"><span class="nav-number">2.</span> <span class="nav-text">行业趋势</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关论文"><span class="nav-number">3.</span> <span class="nav-text">相关论文</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#背景起源"><span class="nav-number">4.</span> <span class="nav-text">背景起源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#语言特性"><span class="nav-number">5.</span> <span class="nav-text">语言特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基本原理"><span class="nav-number">6.</span> <span class="nav-text">基本原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#转发模型-Forwarding-Model"><span class="nav-number">6.1.</span> <span class="nav-text">转发模型(Forwarding Model)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#P4-VS-OpenFlow"><span class="nav-number">6.1.1.</span> <span class="nav-text">P4 VS OpenFlow</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#核心部件-Key-Component"><span class="nav-number">6.2.</span> <span class="nav-text">核心部件(Key Component)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#头部-Header"><span class="nav-number">6.2.1.</span> <span class="nav-text">头部(Header)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解析器-Parser"><span class="nav-number">6.2.2.</span> <span class="nav-text">解析器(Parser)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#匹配-动作表-Match-Action-Table"><span class="nav-number">6.2.3.</span> <span class="nav-text">匹配-动作表(Match-Action Table)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#动作-Action"><span class="nav-number">6.2.4.</span> <span class="nav-text">动作(Action)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#控制程序-Control-Program"><span class="nav-number">6.2.5.</span> <span class="nav-text">控制程序(Control Program)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译器-Compiler"><span class="nav-number">6.3.</span> <span class="nav-text">编译器(Compiler)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#工作流-Work-Flow"><span class="nav-number">6.4.</span> <span class="nav-text">工作流(Work Flow)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#发展趋势"><span class="nav-number">7.</span> <span class="nav-text">发展趋势</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资源"><span class="nav-number">8.</span> <span class="nav-text">参考资源</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sun Dongxu</span>
</div>


  <div class="powered-by">
    <i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
    访客数  <span id="busuanzi_value_site_uv"></span></span>
  <span class="post-meta-divider">|</span>
  </div>

  <div class="powered-by">
    <i class="fa fa-bolt"></i><span id="busuanzi_container_site_pv">
    点击量  <span id="busuanzi_value_site_pv"></span></span>
  <span class="post-meta-divider">|</span>
  </div>

  <div class="powered-by">
    
      <span class="post-meta-item-icon">
      <i class="fa fa-pencil"></i></span>
      博客全站共
      <span title="Site words total count">97.3k 字</span>
    
   </div>










        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  










  
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7-rc3/dist/Valine.min.js"></script>
  <script type="text/javascript">
    new Valine({
        av: AV,
        el: '#comments' ,
        verify: false,
        notify: false,
        app_id: 'GahxsYhy86LRoRJ6jNOKbsjd-gzGzoHsz',
        app_key: '3LFhgQbpJqib03QEIBwCbAN4',
        placeholder: ''
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("YGwn9ugsopQVcGsCsO02SAak-gzGzoHsz", "lpK3dw1VUUeKtFIouqwCMjuz");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  
  
    <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
</body>
</html>
