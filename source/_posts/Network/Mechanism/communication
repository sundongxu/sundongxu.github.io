---
title: 记一次完整的网络通信过程
date: 2017-11-05 19:00:00
categories:
- Network
tags:
- Communication
- Forwarding
- Routing
- ARP
---

### 全文概要
写完前面几篇对网络硬件设备以及对应工作机制的介绍之后，我觉得有必要再多有一篇博文对网络中的端到端通信过程进行完整的解析，本文对同一网段内、跨网段节点通信两种情形分别列举两个简单示例，分别描述了通信过程中各硬件设备和网络协议的协同工作流程。
<!--more-->

## 通用流程
网络设备之间的通信通常经过如下几个步骤：
1. 发送节点应用程序生成数据，准备向外发送一个数据包；
2. 系统(TCP/IP协议栈)判断这个数据包的目标地址是否在同一个网段：本机IP地址和目的IP地址分别与子网掩码作按位与操作，结果一致则在同一网段，否则分别位处不同网段；
3. 若目的节点与发送节点属于同一网段，系统直接将数据包封装成帧，通过二层设备(如交换机)转发至本网段内的目标地址；
4. 若目的节点与发送节点不在同一网段，系统将数据包转发到路由表指示的对应该目的地址所在网段的网关，并在网关处重新封装；
5. 网关提取数据包送达的目标IP地址并查找路由表对应表项，决定转发端口；
7. 重新封装数据包转发到下一个网关；
8. 直到网关发现目标地址属于本网段，查找MAC表，封装成帧发送到目标节点网卡；
9. 目标节点验证目的IP地址是自身的IP地址后传送给上层应用。

**注意**：网关通常指的是路由器的一个物理端口，此时路由器称为“网关路由器”。路由器转发数据包时不会对它的源IP地址和目的IP地址做修改，只会修改MAC地址。

## 网内通信
网内通信，即通信双方都位处同一网段中，数据传输无需经过路由器，由本网段自主完成。

以下图拓扑为例：


## 网际通信
网际通信，或说网段通信，即通信双方分处不同网段，数据传输需要路由器完成不同网段的连接。

以下图拓扑为例：

