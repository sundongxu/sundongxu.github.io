---
title: P4学习笔记(1)：背景起源与基本原理
date: 2017-10-28 10:29:26
categories:
- Network
tags:
- P4
- SDN
- Network Visualization
---

## 行业趋势
---
SDN is the future, and P4 defines it. 
SDN是未来，P4定义未来。

<!--more-->

## 相关论文
---
[《P4: Programming Protocol-Independent Packet Processors》](https://arxiv.org/pdf/1312.1719.pdf), SIGCOMM Communication Review, 2014.

## 背景起源
---
P4是由P.Bosshart等人提出的一种用于处理数据包转发的高层抽象语言，协议独立(Protocol-Independent)是其核心特点，如OpenFlow一样是一种[南向协议](https://zhuanlan.zhihu.com/p/26743952)，但是其应用范围要比OpenFlow还要大：不仅可以指导数据流转发，更提供了对交换机等网络转发设备的SDN数据平面的编程接口，实现了在设备层对数据处理流程进行软件定义，是真正意义上的软件定义网络(Software Defined Network, SDN)。

就如论文中所说：

> We propose P4 as a strawman proposal for how OpenFlow should evolve in the Future.

目前，P4语言作为一种潜在的OpenFlow2.0的发展方向在努力。

与华为POF提出目的类似，P4的提出的目的也是为了解决OpenFlow可编程能力不足及其协议设计本身所带来的高复杂度(Complexity)和较差可扩展性(Scalability)的难题。

自从OpenFlow 1.0发布以来，其版本目前已演进到[1.5](https://www.opennetworking.org/wp-content/uploads/2014/10/openflow-switch-v1.5.1.pdf)，为了兼容多种不同的网络协议，使OpenFlow交换机能够处理具有不同头部的数据包，其匹配域(Header Field)的个数从1.0版本的12元组，变成1.3版本的40个，到最新1.5版本的45个，其匹配域数目随着新版本支持特性的更新不断增加，OpenFlow匹配域个数随版本演变情况具体见下表：

<style> 
  table th:nth-of-type(1) {
      width: 150px; 
  }
</style>

<style>
  table th:nth-of-type(2) {
      width: 150px;
}
</style>

| Version |   Date   |             Header Fields             |
| :----:  | :------: | :-----------------------------------: |
| OF 1.0  | Dec 2009 | 12 fields(Ethernet, TCP/IPv4)         |
| OF 1.1  | Feb 2011 | 15 fields(MPLS, inter-table metadata) |
| OF 1.2  | Dec 2011 | 36 fields(ARP, ICMP, IPv6, etc)       |
| OF 1.3  | Jun 2012 | 40 fields                             |
| OF 1.4  | Oct 2013 | 41 fields                             |
| OF 1.5  | Dec 2014 | 45 fields                             |

但OpenFlow本身并不支持弹性增加匹配域，因此每次增加一个匹配域就需要重新编写控制器(Controller)和交换机两端的协议栈以及交换机的数据包处理逻辑，这无疑大大增加了交换机设计的难度，也严重影响OpenFlow协议的版本稳定性，影响OpenFlow的推广。

## 语言特性 
---
根据论文所述，P4致力于实现以下三个目标：
1. **可重配置性(Reconfigurability)**
    
    > Programmers should be able to change the way switches process packets once they are deployed.

    可灵活定义转发设备数据处理流程，且能够做到转发无中断的重配置。OpenFlow能够在已经固化在交换机上的数据处理逻辑之上，通过流表项指导数据流转发处理，而无法重新定义交换机处理数据的逻辑，每次增加新的网络协议支持，都必须将相关设备宕机下线并重新配置后再重新部署上线，即无法在不中断其它数据包转发的情况下弹性支持新协议。但是P4的卖点恰恰在于其拥有对交换机的数据平面，即数据包处理逻辑即时编程的能力。

2. **协议无关性(Protocol-Independence)**

    > Switches should not be tied to any specific network protocols.

    交换机等转发设备无需关心协议语法和语义等内容，依然能够完成数据处理转发任务。这是因为P4可以自定义数据处理逻辑，并通过控制器对交换机等转发设备编程实现对应的协议处理逻辑，而这个行为(Behavior)将被翻译成对应的匹配(Match)和动作(Action)，从而被转发设备理解和执行。

3. **目标设备无关性(Target-Independence)**

    > Programmers should be able to describe packet-processing functionality independently of the underlying hardware.

    正如写C和Java(CPU-oriented Languauge，面向CPU编程语言)代码时并不需要关系CPU的相关信息，使用P4语言()进行网络编程同样无需关心底层设备的具体信息。P4的编译器(Compiler)会将通用的P4语言处理逻辑翻译成设备所能理解的机器指令，从而写入转发设备，完成配置和编程。

## P4 vs OpenFlow
---


{% qnimg P4/P4vsOpenFlow.png %}


## 基本原理
---

